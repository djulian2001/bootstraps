# bootstraps.lib
: '
library file bootstraps

Description:
	This is a script that takes in command line args and sets up an ansible 
	controller node.  Following the instructions from the ansible docs we will
	be using the pip install method.

	Why pip?
		Pip will have the latest core modules.
		The source code will not have been changed and module behavior should
			follow the docs
		Its very easy to do
		If down the road, ansible versions have to be coupled to deployments we
			can easily manage ansible versions using python module virtualenv 
			and the virtualenv wrapper 

Expected Results:
	The ansible tool will be installed.
	The deployment user (normally ansible) will be created on the control server
	The deployment user will be given sudo privileges on the control server 
		- file: /etc/sudoers
	The deployment user will be created on all of the remote hosts
	The deployment user will be given sudo privileges using the /etc/sudoers file
	The deployment

user scope:
	This script has to be run by a user with sudo privileges.
	The user has to have sudo privileges on the remote hosts.

bootstrap dependencies:
	sshpass
	epel

ansible dependencies:
	python-pip 
	python-devel 
	openssl-devel.x86_64

other dependencies:
	git


sources: 
http://docs.ansible.com/ansible/intro_installation.html#latest-releases-via-pip

'

check_env()
{
	# check that these env variables are set first	
	
	: "${ SSHPASS:?Export SSHPASS with admin password, prepend with a space }"

	if [[ ! "${1}" -eq "init" ]]; then
		: "${REMOTE_USER_PASSWORD:?Export REMOTE_USER_PASSWORD with deployer password, prepend with a space}"
	fi
}

check_setup()
{
	echo "check setup ....."
	export HISTCONTROL="$HISTCONTROL:ignorespace"
	# check hosts file exists
	# check sudoers.d file exists
}

required_dependencies()
{
	echo "installing dependencies ...."
	check_setup
	check_env "init"

	if [ ! "$?" -eq 0 ]; then
		env_instructions
	fi

	# enable epel
	echo "installing with yum  ...."
	/bin/echo "${SSHPASS}" | sudo -S yum -y install epel-release
	/bin/echo "${SSHPASS}" | sudo -S yum --enablerepo=epel -y install epel-release
	/bin/echo "${SSHPASS}" | sudo -S yum install -y git sshpass
}


ansible_dependencies()
{
	# setup and install ansible with pip..
	echo "INSTALL ansible using pip..."
	/bin/echo "${SSHPASS}" | sudo -S yum -y install python-pip python-devel openssl-devel.x86_64
	/bin/echo "${SSHPASS}" | sudo -S pip install --upgrade pip
	/bin/echo "${SSHPASS}" | sudo -S pip install ansible
	/bin/echo "${SSHPASS}" | sudo -S pip install --upgrade ansible
}

add_hosts_to_known_hosts()
{
	# FUTURE TASK!!!
	echo "NEED TO ADD THIS!!!!"
	echo "hosts inventory need to be added to the known hosts to boot strap with?"
	echo "work around is add 'StrictHostKeyChecking no' to admins .ssh/config file"

}


env_instructions()
{

	/usr/bin/cat <<-EOF
		Usage Instructions:
			-- prepend ANY cmds with a space to avoid writing to history
			
			-- set enviornment variables:
			--	* export SSHPASS="...."
			--	* export DEPLOY_USER_PASSWORD="...."
				* prepend with a space

			-- Re-Run the bash script init.sh
	EOF
}
